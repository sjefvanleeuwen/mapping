<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Mapping Tool | AdminLTE 4</title>
    
    <!--begin::Fonts-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" crossorigin="anonymous" />
    <!--end::Fonts-->
    
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css" crossorigin="anonymous" />
    <!--end::Third Party Plugin(OverlayScrollbars)-->
    
    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" crossorigin="anonymous" />
    <!--end::Third Party Plugin(Bootstrap Icons)-->
    
    <!--begin::Bootstrap CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
    <!--end::Bootstrap CSS-->
    
    <!--begin::Required Plugin(AdminLTE) - Using unpkg as fallback-->
    <link rel="stylesheet" href="https://unpkg.com/admin-lte@4.0.0-beta3/dist/css/adminlte.min.css" crossorigin="anonymous" />
    <!--end::Required Plugin(AdminLTE)-->
    
    <!--begin::Toastify CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css" crossorigin="anonymous" />
    <!--end::Toastify CSS-->
    
    <!-- Custom Styles for Mapping Tool -->
    <link rel="stylesheet" href="mapping-styles.css">
    
    <style>
        /* Debug: Ensure functoid menu items are visible */
        #functoids {
            display: block !important;
            visibility: visible !important;
        }
        #functoids .nav-item {
            display: list-item !important;
        }
        #functoids .nav-link {
            display: flex !important;
        }
        
        /* Fixed Layout with Split.js - Override AdminLTE */
        body.layout-fixed {
            overflow: hidden !important;
            margin: 0;
            padding: 0;
            height: 100vh !important;
        }
        
        html, body {
            height: 100%;
        }
        
        .app-wrapper {
            height: 100vh !important;
            display: flex !important;
            flex-direction: column !important;
            min-height: 100vh;
        }
        
        .app-sidebar {
            position: fixed !important;
            height: 100vh !important;
            top: 0 !important;
            left: 0;
            transition: left 0.3s ease, margin-left 0.3s ease;
            z-index: 1050;
        }
        
        /* AdminLTE sidebar collapsed state */
        body.sidebar-collapse .app-sidebar {
            margin-left: -250px;
        }
        
        .app-main {
            flex: 1 1 auto !important;
            overflow: hidden !important;
            position: relative !important;
            min-height: 0 !important;
            margin-left: 250px; /* Sidebar width */
            height: 100vh !important; /* Full viewport height */
            transition: margin-left 0.3s ease;
        }
        
        /* When sidebar is collapsed, expand main content */
        body.sidebar-collapse .app-main {
            margin-left: 0;
        }
        
        /* Split.js Container */
        #splitContainer {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Split.js Styling */
        .split {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .split-panel {
            overflow: auto;
            box-sizing: border-box;
        }
        
        #mappingPanel {
            overflow: hidden !important;
        }
        
        .gutter {
            background-color: #dee2e6;
            background-repeat: no-repeat;
            background-position: 50%;
        }
        
        .gutter.gutter-vertical {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
            cursor: row-resize;
            height: 8px;
        }
        
        .gutter:hover {
            background-color: #6c757d;
        }
        
        /* Compact UI Styles */
        .card-header {
            padding: 0.5rem 1rem !important;
        }
        
        .card-header h5 {
            font-size: 0.9rem !important;
            margin: 0 !important;
        }
        
        /* Tab Styles */
        .nav-tabs .nav-link {
            color: rgba(255,255,255,0.7) !important;
            border: none !important;
        }
        
        .nav-tabs .nav-link.active {
            color: white !important;
            background: rgba(255,255,255,0.1) !important;
            border-bottom: 2px solid white !important;
        }
        
        .nav-tabs .nav-link:hover {
            background: rgba(255,255,255,0.05) !important;
        }
        
        .card-body {
            padding: 0.75rem !important;
        }
        
        /* Override for mapping canvas - no padding */
        #mappingPanel .card-body {
            padding: 0 !important;
        }
        
        /* Remove all rounded corners globally */
        * {
            border-radius: 0 !important;
        }
        
        .form-label {
            font-size: 0.8rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        .form-control {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        textarea.form-control {
            line-height: 1.3 !important;
        }
        
        .btn {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.75rem !important;
        }
        
        .btn-sm {
            font-size: 0.7rem !important;
            padding: 0.2rem 0.5rem !important;
        }
        
        .badge {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        .row {
            margin-left: -0.5rem !important;
            margin-right: -0.5rem !important;
        }
        
        .row > * {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        .mb-3 {
            margin-bottom: 0.5rem !important;
        }
        
        .mb-2 {
            margin-bottom: 0.25rem !important;
        }
        
        .gap-2 {
            gap: 0.5rem !important;
        }
        
        /* Terminal Style Theme */
        .terminal-panel {
            background: #1e1e1e !important;
            border: none !important;
        }
        
        .terminal-header {
            background: #252526 !important;
            border-bottom: 1px solid #3c3c3c !important;
            color: #cccccc !important;
            font-family: 'Consolas', 'Courier New', monospace !important;
        }
        
        .terminal-tab {
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            padding: 0.4rem 0.8rem !important;
            border: none !important;
            background: transparent !important;
            color: #969696 !important;
        }
        
        .terminal-tab.active {
            background: #1e1e1e !important;
            color: #ffffff !important;
            border-bottom: 2px solid #007acc !important;
        }
        
        .terminal-tab:hover {
            color: #ffffff !important;
            background: #2a2d2e !important;
        }
        
        .terminal-input, .terminal-output {
            width: 100%;
            background: #1e1e1e !important;
            border: 1px solid #3c3c3c !important;
            color: #d4d4d4 !important;
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            padding: 0.5rem !important;
            resize: vertical;
        }
        
        .terminal-input:focus, .terminal-output:focus {
            outline: none !important;
            border-color: #007acc !important;
            box-shadow: none !important;
        }
        
        .terminal-label {
            color: #608b4e !important;
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            margin: 0 !important;
            padding: 0.1rem 0.25rem !important;
            background: #252526 !important;
            display: block;
            line-height: 1.2;
        }
        
        .terminal-toolbar {
            background: #2d2d30 !important;
            padding: 0.1rem 0.25rem !important;
            border-bottom: 1px solid #3c3c3c !important;
            display: flex;
            align-items: center;
            gap: 0.15rem;
            min-height: 24px;
        }
        
        .terminal-toolbar .btn-sm {
            padding: 0.1rem 0.35rem !important;
            font-size: 0.7rem !important;
            line-height: 1.2 !important;
        }
        
        .terminal-body {
            background: #1e1e1e !important;
            color: #d4d4d4 !important;
        }
        
        /* Fix tab panes to show properly */
        .terminal-body .tab-content {
            height: 100%;
        }
        
        .terminal-body .tab-pane {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        
        .terminal-body .tab-pane.show.active {
            display: flex !important;
        }
        
        /* JSON Syntax Highlighting (VS Code Dark+ theme) */
        .json-output {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            background: #1e1e1e !important;
            color: #d4d4d4 !important;
            padding: 0.5rem !important;
            margin: 0 !important;
            border: 1px solid #3c3c3c !important;
            border-radius: 0 !important;
        }
        
        .json-key { 
            color: #9cdcfe !important; 
            font-weight: normal !important;
        }
        
        .json-string { 
            color: #ce9178 !important; 
        }
        
        .json-number { 
            color: #b5cea8 !important; 
        }
        
        .json-boolean { 
            color: #569cd6 !important; 
            font-weight: bold !important;
        }
        
        .json-null { 
            color: #569cd6 !important; 
            font-weight: bold !important;
        }
        
        .json-punctuation { 
            color: #d4d4d4 !important; 
        }
    </style>
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
        <!--begin::Sidebar-->
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
            <!--begin::Sidebar Brand-->
            <div class="sidebar-brand">
                <a href="#" class="brand-link">
                    <i class="bi bi-diagram-3 brand-image"></i>
                    <span class="brand-text fw-light">Mapping Tool</span>
                </a>
            </div>
            <!--end::Sidebar Brand-->
            
            <!--begin::Sidebar Wrapper-->
            <div class="sidebar-wrapper">
                <nav class="mt-2">
                    <ul class="nav sidebar-menu flex-column" role="menu">
                        <li class="nav-header">CONFIGURATION</li>
                        <li class="nav-item">
                            <a href="#schemaConfig" class="nav-link active" data-bs-toggle="collapse">
                                <i class="nav-icon bi bi-gear"></i>
                                <p>
                                    Schema Setup
                                    <i class="nav-arrow bi bi-chevron-right"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview collapse show" id="schemaConfig">
                                <li class="nav-item">
                                    <a href="#" class="nav-link" id="navLoadSchemas">
                                        <i class="nav-icon bi bi-upload"></i>
                                        <p>Load Schemas</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link" id="navLoadSample">
                                        <i class="nav-icon bi bi-file-code"></i>
                                        <p>Load Sample</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <li class="nav-header">MAPPING</li>
                        <li class="nav-item">
                            <a href="#functoids" class="nav-link" data-bs-toggle="collapse">
                                <i class="nav-icon bi bi-box"></i>
                                <p>
                                    Functoids
                                    <i class="nav-arrow bi bi-chevron-right"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview collapse show" id="functoids">
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="string" draggable="true">
                                        <i class="nav-icon bi bi-fonts"></i>
                                        <p>String</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="math" draggable="true">
                                        <i class="nav-icon bi bi-calculator"></i>
                                        <p>Math</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="logical" draggable="true">
                                        <i class="nav-icon bi bi-check-square"></i>
                                        <p>Logical</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="conversion" draggable="true">
                                        <i class="nav-icon bi bi-arrow-left-right"></i>
                                        <p>Conversion</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <li class="nav-header">ACTIONS</li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="navExecute">
                                <i class="nav-icon bi bi-play-fill text-success"></i>
                                <p>Execute Mapping</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="navGenerate">
                                <i class="nav-icon bi bi-code-square"></i>
                                <p>Generate JSON</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="clearMappings">
                                <i class="nav-icon bi bi-trash text-danger"></i>
                                <p>Clear All</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            <!--end::Sidebar Wrapper-->
        </aside>
        <!--end::Sidebar-->
        
        <!--begin::App Main-->
        <main class="app-main" style="padding: 0;">
            <!-- Sidebar Toggle Button (AdminLTE style) -->
            <button class="btn btn-link position-fixed" data-lte-toggle="sidebar" 
                    style="top: 10px; left: 10px; z-index: 1000; color: #6c757d; font-size: 1.5rem; padding: 0.25rem 0.5rem;">
                <i class="bi bi-list"></i>
            </button>
            
            <div class="split" id="splitContainer">
            
                <!-- Top Panel: Mapping Canvas (75%) -->
                <div class="split-panel" id="mappingPanel">
                    <div class="card mb-0" style="height: 100%; border: none; display: flex; flex-direction: column;">
                        <div class="card-body p-0" style="flex: 1; overflow: hidden;">
                            <div class="mapping-tool">
                                <!-- Source Schema Panel -->
                                <div class="schema-panel source-panel">
                                    <div class="panel-header bg-primary text-white" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        <i class="bi bi-box-arrow-right me-1"></i>Source
                                    </div>
                                    <div class="schema-tree" id="sourceSchema">
                                        <div class="text-center text-muted p-2">
                                            <i class="bi bi-inbox" style="font-size: 1.5rem;"></i>
                                            <p class="mt-1 mb-0" style="font-size: 0.75rem;">Load schema</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mapping Canvas -->
                                <div class="mapping-canvas">
                                    <svg id="mappingSvg" class="mapping-svg"></svg>
                                    <div class="functoid-area" id="functoidArea"></div>
                                </div>

                                <!-- Destination Schema Panel -->
                                <div class="schema-panel destination-panel">
                                    <div class="panel-header bg-success text-white" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        <i class="bi bi-box-arrow-in-left me-1"></i>Destination
                                    </div>
                                    <div class="schema-tree" id="destinationSchema">
                                        <div class="text-center text-muted p-2">
                                            <i class="bi bi-inbox" style="font-size: 1.5rem;"></i>
                                            <p class="mt-1 mb-0" style="font-size: 0.75rem;">Load schema</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Panel: Configuration & Output (25%) -->
                <div class="split-panel" id="configPanel">
                    <div class="card mb-0 terminal-panel" style="height: 100%; border: none; display: flex; flex-direction: column;">
                        <div class="card-header terminal-header p-0" style="flex-shrink: 0;">
                            <ul class="nav nav-tabs" role="tablist" style="margin: 0; border: none; background: transparent;">
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-content" type="button" role="tab">
                                        <i class="bi bi-file-earmark-code me-1"></i>schemas.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="sample-tab" data-bs-toggle="tab" data-bs-target="#sample-content" type="button" role="tab">
                                        <i class="bi bi-database me-1"></i>sample.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="mapping-tab" data-bs-toggle="tab" data-bs-target="#mapping-content" type="button" role="tab">
                                        <i class="bi bi-diagram-2 me-1"></i>mapping.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="output-tab" data-bs-toggle="tab" data-bs-target="#output-content" type="button" role="tab">
                                        <i class="bi bi-play-circle me-1"></i>output.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="csharp-tab" data-bs-toggle="tab" data-bs-target="#csharp-content" type="button" role="tab">
                                        <i class="bi bi-filetype-cs me-1"></i>mapper.cs
                                    </button>
                                </li>
                                <li class="nav-item ms-auto" style="display: flex; align-items: center; padding-right: 0.5rem;">
                                    <span class="badge bg-info me-2" id="mappingCount" style="font-size: 0.7rem; font-family: 'Consolas', monospace;">0 mappings</span>
                                    <button class="btn btn-sm btn-link text-white p-0" id="toggleFullscreen" title="Toggle Fullscreen" style="font-size: 1rem; line-height: 1;">
                                        <i class="bi bi-arrows-fullscreen"></i>
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body terminal-body p-0" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                            <div class="tab-content" style="flex: 1; overflow: hidden; padding: 0; margin: 0;">
                                <!-- schemas.json Tab -->
                                <div class="tab-pane fade show active" id="config-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-secondary me-1" id="loadSchemas" title="Load Schemas">
                                            <i class="bi bi-upload me-1"></i>Load
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="formatSchemaJSON()" title="Format JSON">
                                            <i class="bi bi-code-square me-1"></i>Format
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Source Schema:</label>
                                        <json-editor id="sourceSchemaInput" rows="4" style="flex: 1; min-height: 60px;"></json-editor>
                                        <label class="terminal-label" style="margin: 0;">Destination Schema:</label>
                                        <json-editor id="destSchemaInput" rows="4" style="flex: 1; min-height: 60px;"></json-editor>
                                    </div>
                                </div>

                                <!-- sample.json Tab -->
                                <div class="tab-pane fade" id="sample-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-secondary me-1" id="loadSampleData" title="Load Sample">
                                            <i class="bi bi-file-earmark-code me-1"></i>Load
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="formatSampleJSON()" title="Format JSON">
                                            <i class="bi bi-code-square me-1"></i>Format
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Sample Input Data:</label>
                                        <json-editor id="sourceDataInput" rows="10" style="flex: 1; min-height: 100px;"></json-editor>
                                    </div>
                                </div>

                                <!-- mapping.json Tab -->
                                <div class="tab-pane fade" id="mapping-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-primary me-1" id="generateOutput" title="Generate Mapping">
                                            <i class="bi bi-download me-1"></i>Generate
                                        </button>
                                        <button class="btn btn-sm btn-warning me-1" onclick="clearAll()" title="Clear All Mappings">
                                            <i class="bi bi-trash me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-sm btn-info me-1" id="loadMapping" title="Load Mapping">
                                            <i class="bi bi-upload me-1"></i>Load
                                        </button>
                                        <button class="btn btn-sm btn-secondary" id="copyOutput" title="Copy to Clipboard">
                                            <i class="bi bi-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Generated Mapping JSON:</label>
                                        <json-viewer id="mappingOutput" style="flex: 1; min-height: 100px;"></json-viewer>
                                    </div>
                                </div>

                                <!-- output.json Tab -->
                                <div class="tab-pane fade" id="output-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-success me-1" id="executeMapping" title="Execute Mapping">
                                            <i class="bi bi-play-fill me-1"></i>Execute
                                        </button>
                                        <button class="btn btn-sm btn-secondary" id="copyResult" title="Copy to Clipboard">
                                            <i class="bi bi-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Execution Result:</label>
                                        <json-viewer id="executionResult" style="flex: 1; min-height: 100px;"></json-viewer>
                                    </div>
                                </div>

                                <!-- mapper.cs Tab -->
                                <div class="tab-pane fade" id="csharp-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-primary me-1" id="generateCSharp" title="Generate C# Code">
                                            <i class="bi bi-code-slash me-1"></i>Generate
                                        </button>
                                        <button class="btn btn-sm btn-secondary" id="copyCSharp" title="Copy to Clipboard">
                                            <i class="bi bi-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Generated C# Mapper Class:</label>
                                        <csharp-viewer id="csharpOutput" style="flex: 1; min-height: 100px;"></csharp-viewer>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <!-- End Split Container -->
        </main>
        <!--end::App Main-->
    </div>
    <!--end::App Wrapper-->
    
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js" crossorigin="anonymous"></script>
    <!--end::Third Party Plugin(OverlayScrollbars)-->
    
    <!--begin::Required Plugin(popperjs for Bootstrap 5)-->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <!--end::Required Plugin(popperjs for Bootstrap 5)-->
    
    <!--begin::Required Plugin(Bootstrap 5)-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!--end::Required Plugin(Bootstrap 5)-->
    
    <!--begin::Required Plugin(AdminLTE) - Using unpkg as fallback-->
    <script src="https://unpkg.com/admin-lte@4.0.0-beta3/dist/js/adminlte.min.js" crossorigin="anonymous"></script>
    <!--end::Required Plugin(AdminLTE)-->
    
    <!--begin::Toastify JS-->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js" crossorigin="anonymous"></script>
    <!--end::Toastify JS-->
    
    <!--begin::Split.js for Resizable Panes-->
    <script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js"></script>
    <!--end::Split.js-->
    
    <!--begin::Toast Helper Function-->
    <script>
        // Global toast notification helper
        window.showToast = function(message, type = 'info') {
            const styles = {
                success: {
                    background: '#10b981',
                    color: '#ffffff'
                },
                error: {
                    background: '#ef4444',
                    color: '#ffffff'
                },
                warning: {
                    background: '#f59e0b',
                    color: '#000000'
                },
                info: {
                    background: '#3b82f6',
                    color: '#ffffff'
                }
            };
            
            const style = styles[type] || styles.info;
            
            Toastify({
                text: message,
                duration: 3000,
                gravity: "bottom",
                position: "right",
                stopOnFocus: true,
                style: {
                    background: style.background,
                    color: style.color,
                    borderRadius: "4px",
                    fontFamily: "'Consolas', 'Courier New', monospace",
                    fontSize: "0.85rem",
                    fontWeight: "500",
                    minWidth: "300px",
                    maxWidth: "300px"
                }
            }).showToast();
        };
    </script>
    <!--end::Toast Helper Function-->
    
    <!--begin::OverlayScrollbars Configure-->
    <script>
        const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
        const Default = {
            scrollbarTheme: "os-theme-light",
            scrollbarAutoHide: "leave",
            scrollbarClickScroll: true
        };
        
        document.addEventListener("DOMContentLoaded", function() {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && typeof OverlayScrollbarsGlobal !== 'undefined') {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: {
                        theme: Default.scrollbarTheme,
                        autoHide: Default.scrollbarAutoHide,
                        clickScroll: Default.scrollbarClickScroll
                    }
                });
            }
        });
    </script>
    <!--end::OverlayScrollbars Configure-->
    
    <!-- JSON Viewer Web Component -->
    <script src="components/json-viewer.js"></script>
    
    <!-- JSON Editor Web Component -->
    <script src="components/json-editor.js"></script>
    
    <!-- C# Viewer Web Component -->
    <script src="components/csharp-viewer.js"></script>
    
    <!-- Mapping Tool Core Logic -->
    <script src="mapping-tool.js"></script>
    
    <!-- Global Helper Functions -->
    <script>
        // Format JSON functions for toolbar buttons
        function formatSchemaJSON() {
            const sourceInput = document.getElementById('sourceSchemaInput');
            const destInput = document.getElementById('destSchemaInput');
            
            if (sourceInput && sourceInput.getValue) {
                try {
                    const json = JSON.parse(sourceInput.getValue());
                    sourceInput.setValue(JSON.stringify(json, null, 2));
                } catch (e) {
                    showToast('Invalid JSON in Source Schema', 'error');
                }
            }
            
            if (destInput && destInput.getValue) {
                try {
                    const json = JSON.parse(destInput.getValue());
                    destInput.setValue(JSON.stringify(json, null, 2));
                } catch (e) {
                    showToast('Invalid JSON in Destination Schema', 'error');
                }
            }
        }
        
        function formatSampleJSON() {
            const sampleInput = document.getElementById('sourceDataInput');
            if (sampleInput && sampleInput.getValue) {
                try {
                    const json = JSON.parse(sampleInput.getValue());
                    sampleInput.setValue(JSON.stringify(json, null, 2));
                } catch (e) {
                    showToast('Invalid JSON in Sample Data', 'error');
                }
            }
        }
        
        function clearAll() {
            if (window.mappingToolInstance && window.mappingToolInstance.clearAllMappings) {
                window.mappingToolInstance.clearAllMappings();
            }
        }
    </script>
    
    <!-- Sidebar Navigation Handlers -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Watch for AdminLTE sidebar toggle events
            document.addEventListener('click', function(e) {
                const toggleBtn = e.target.closest('[data-lte-toggle="sidebar"]');
                if (toggleBtn) {
                    // Redraw mapping lines after sidebar animation completes
                    setTimeout(() => {
                        if (window.mappingToolInstance && window.mappingToolInstance.updateAllMappingLines) {
                            window.mappingToolInstance.updateAllMappingLines();
                        }
                    }, 300);
                }
            });
            
            // Link sidebar actions to main buttons
            document.getElementById('navLoadSchemas')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loadSchemas').click();
            });
            
            document.getElementById('navLoadSample')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loadSampleData').click();
            });
            
            document.getElementById('navExecute')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('executeMapping')?.click();
            });
            
            document.getElementById('navGenerate')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('generateOutput').click();
            });
            
            // Functoid sidebar links - handle both class and data-functoid for backwards compatibility
            document.querySelectorAll('.functoid-btn, [data-functoid]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const type = link.getAttribute('data-type') || link.getAttribute('data-functoid');
                    // Access the global MappingTool instance
                    if (window.mappingToolInstance && type) {
                        window.mappingToolInstance.addFunctoid(type);
                    }
                });
            });
            
            // Update mapping count
            function updateMappingCount() {
                const count = window.mappingToolInstance?.mappings?.length || 0;
                const badge = document.getElementById('mappingCount');
                if (badge) {
                    badge.textContent = `${count} mapping${count !== 1 ? 's' : ''}`;
                }
            }
            
            // Call update every second (or trigger from mapping tool)
            setInterval(updateMappingCount, 1000);
            
            // Fullscreen toggle
            document.getElementById('toggleFullscreen')?.addEventListener('click', function() {
                const splitContainer = document.getElementById('splitContainer');
                if (!document.fullscreenElement) {
                    splitContainer.requestFullscreen().catch(err => {
                        console.error('Error attempting to enable fullscreen:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            });
            
            // C# Code Generation
            document.getElementById('generateCSharp')?.addEventListener('click', function() {
                if (window.mappingToolInstance) {
                    const csharpCode = window.mappingToolInstance.generateCSharpCode();
                    const outputElement = document.getElementById('csharpOutput');
                    if (outputElement && csharpCode) {
                        // Use the setCode method for csharp-viewer
                        outputElement.setCode(csharpCode);
                        showToast('C# code generated successfully!', 'success');
                    }
                }
            });
            
            document.getElementById('copyCSharp')?.addEventListener('click', function() {
                const outputElement = document.getElementById('csharpOutput');
                if (outputElement) {
                    const code = outputElement.getText();
                    if (!code) {
                        showToast('Please generate C# code first!', 'warning');
                        return;
                    }
                    navigator.clipboard.writeText(code).then(() => {
                        showToast('C# code copied to clipboard!', 'success');
                    }).catch(err => {
                        showToast('Failed to copy: ' + err, 'error');
                    });
                }
            });
            
            // Initialize Split.js for resizable panes - mapping on top, config on bottom
            console.log('Initializing Split.js...');
            console.log('Split available:', typeof Split);
            console.log('Mapping panel:', document.getElementById('mappingPanel'));
            console.log('Config panel:', document.getElementById('configPanel'));
            
            if (typeof Split !== 'undefined') {
                const splitInstance = Split(['#mappingPanel', '#configPanel'], {
                    direction: 'vertical',
                    sizes: [75, 25],  // Initial sizes: 75% canvas, 25% config/output
                    minSize: [300, 150],  // Minimum sizes for each panel
                    gutterSize: 8,
                    cursor: 'row-resize',
                    onDragEnd: function() {
                        console.log('Split drag ended');
                        // Redraw mapping lines after resize
                        if (window.mappingToolInstance && window.mappingToolInstance.updateAllMappingLines) {
                            window.mappingToolInstance.updateAllMappingLines();
                        }
                    }
                });
                console.log('Split.js initialized:', splitInstance);
            } else {
                console.error('Split.js not loaded!');
            }
        });
    </script>
</body>
</html>
