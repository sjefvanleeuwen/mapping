<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Mapping Tool | AdminLTE 4</title>
    
    <!--begin::Fonts-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" crossorigin="anonymous" />
    <!--end::Fonts-->
    
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css" crossorigin="anonymous" />
    <!--end::Third Party Plugin(OverlayScrollbars)-->
    
    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" crossorigin="anonymous" />
    <!--end::Third Party Plugin(Bootstrap Icons)-->
    
    <!--begin::Bootstrap CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
    <!--end::Bootstrap CSS-->
    
    <!--begin::Required Plugin(AdminLTE) - Using unpkg as fallback-->
    <link rel="stylesheet" href="https://unpkg.com/admin-lte@4.0.0-beta3/dist/css/adminlte.min.css" crossorigin="anonymous" />
    <!--end::Required Plugin(AdminLTE)-->
    
    <!--begin::Toastify CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css" crossorigin="anonymous" />
    <!--end::Toastify CSS-->
    
    <!-- Custom Styles for Mapping Tool -->
    <link rel="stylesheet" href="mapping-styles.css">
    
    <style>
        /* CRITICAL: Make hamburger menu visible */
        .app-header .navbar-nav .nav-link {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-width: 40px !important;
            min-height: 40px !important;
        }
        
        .app-header .bi-list {
            font-size: 1.5rem !important;
            display: inline-block !important;
            line-height: 1 !important;
        }
        
        .app-header .bi-list::before {
            display: inline-block !important;
        }
        
        /* Debug: Ensure functoid menu items are visible */
        #functoids {
            display: block !important;
            visibility: visible !important;
        }
        #functoids .nav-item {
            display: list-item !important;
        }
        #functoids .nav-link {
            display: flex !important;
        }
        
        /* Fixed Layout with Split.js - Work with AdminLTE grid */
        body.layout-fixed {
            overflow: hidden !important;
            margin: 0;
            padding: 0;
            height: 100vh !important;
        }
        
        html, body {
            height: 100%;
        }
        
        /* Don't override app-wrapper - let AdminLTE handle it with grid */
        .app-wrapper {
            min-height: 100vh;
        }
        
        /* Ensure header is positioned correctly with grid layout */
        .app-header {
            position: sticky !important;
            top: 0 !important;
            z-index: 1040 !important; /* Below sidebar but still sticky */
            margin-left: 250px !important; /* Start after sidebar */
            transition: margin-left 0.3s ease-in-out;
            min-height: 2.5rem !important; /* Compact height */
            max-height: 2.5rem !important;
        }
        
        /* Make navbar items more compact */
        .app-header .navbar-nav .nav-link {
            padding: 0.4rem 0.75rem !important;
        }
        
        /* Navbar dropdown menu styling */
        .navbar .dropdown-menu {
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .navbar .dropdown-item {
            padding: 0.4rem 1rem;
            font-size: 0.875rem;
            transition: background-color 0.15s ease-in-out;
        }
        
        .navbar .dropdown-item:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .navbar .dropdown-item.functoid-btn {
            cursor: move;
        }
        
        .navbar .dropdown-item.functoid-btn:active {
            cursor: grabbing;
        }
        
        .navbar .dropdown-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            padding: 0.5rem 1rem 0.25rem;
        }
        
        .navbar .dropdown-divider {
            margin: 0.25rem 0;
        }
        
        /* When sidebar is collapsed, adjust header margin */
        body.sidebar-collapse .app-header {
            margin-left: calc(4.6rem + 1px) !important;
        }
        
        .app-sidebar {
            position: fixed !important;
            height: 100vh !important;
            top: 0 !important;
            left: 0;
            z-index: 1050;
        }
        
        .app-main {
            flex: 1 1 auto !important;
            overflow: hidden !important;
            position: relative !important;
            min-height: 0 !important;
            display: block !important;
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Layout-fixed overrides for app-main positioning */
        body.layout-fixed .app-main {
            margin-left: 250px !important; /* Sidebar width */
            margin-top: 2.5rem !important; /* Compact navbar height */
            height: calc(100vh - 2.5rem) !important;
            box-sizing: border-box !important;
            padding: 0 !important;
            border: none !important;
        }
        
        /* When sidebar is collapsed to mini mode */
        body.layout-fixed.sidebar-collapse .app-main {
            margin-left: calc(4.6rem + 1px) !important; /* Mini sidebar width */
        }
        
        /* Split.js Container - fills app-main exactly */
        #splitContainer {
            height: 100%;
            width: 100%;
            position: relative; /* Changed from absolute */
            overflow: hidden; /* Prevent overflow */
            box-sizing: border-box !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Split.js Styling */
        .split {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden; /* Prevent overflow */
            box-sizing: border-box !important;
        }
        
        .split-panel {
            overflow: hidden; /* Changed from auto to hidden */
            box-sizing: border-box !important;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack children vertically */
            border: none !important;
        }
        
        /* Ensure cards inside split panels fill available space */
        .split-panel > .card {
            flex: 1 1 auto !important;
            min-height: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            border: none !important;
            margin: 0 !important;
        }
        
        .split-panel > .card > .card-body {
            flex: 1 1 auto !important;
            min-height: 0 !important;
            overflow: hidden !important;
        }
        
        #mappingPanel {
            overflow: hidden !important;
        }
        
        /* Ensure terminal panel fits exactly */
        #configPanel {
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        #configPanel .terminal-panel {
            flex: 1 1 auto; /* Take all available space */
            min-height: 0; /* Allow shrinking */
            overflow: hidden;
            margin: 0 !important;
            height: auto !important; /* Override inline height: 100% */
        }
        
        .gutter {
            background-color: #dee2e6;
            background-repeat: no-repeat;
            background-position: 50%;
        }
        
        .gutter.gutter-vertical {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
            cursor: row-resize;
            height: 8px;
        }
        
        .gutter:hover {
            background-color: #6c757d;
        }
        
        /* Compact UI Styles */
        .card-header {
            padding: 0.5rem 1rem !important;
        }
        
        .card-header h5 {
            font-size: 0.9rem !important;
            margin: 0 !important;
        }
        
        /* Tab Styles */
        .nav-tabs .nav-link {
            color: rgba(255,255,255,0.7) !important;
            border: none !important;
        }
        
        .nav-tabs .nav-link.active {
            color: white !important;
            background: rgba(255,255,255,0.1) !important;
            border-bottom: 2px solid white !important;
        }
        
        .nav-tabs .nav-link:hover {
            background: rgba(255,255,255,0.05) !important;
        }
        
        .card-body {
            padding: 0.75rem !important;
        }
        
        /* Override for mapping canvas - no padding */
        #mappingPanel .card-body {
            padding: 0 !important;
        }
        
        /* Remove all rounded corners globally */
        * {
            border-radius: 0 !important;
        }
        
        .form-label {
            font-size: 0.8rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        .form-control {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        textarea.form-control {
            line-height: 1.3 !important;
        }
        
        .btn {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.75rem !important;
        }
        
        .btn-sm {
            font-size: 0.7rem !important;
            padding: 0.2rem 0.5rem !important;
        }
        
        .badge {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        .row {
            margin-left: -0.5rem !important;
            margin-right: -0.5rem !important;
        }
        
        .row > * {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        .mb-3 {
            margin-bottom: 0.5rem !important;
        }
        
        .mb-2 {
            margin-bottom: 0.25rem !important;
        }
        
        .gap-2 {
            gap: 0.5rem !important;
        }
        
        /* Terminal Style Theme */
        .terminal-panel {
            background: #1e1e1e !important;
            border: none !important;
            display: flex !important;
            flex-direction: column !important;
            margin: 0 !important;
        }
        
        .terminal-panel .card-header {
            flex-shrink: 0 !important; /* Don't shrink header */
        }
        
        .terminal-panel .card-body {
            flex: 1 1 auto !important; /* Take remaining space */
            min-height: 0 !important; /* Allow shrinking */
            overflow: hidden !important;
        }
        
        .terminal-header {
            background: #252526 !important;
            border-bottom: 1px solid #3c3c3c !important;
            color: #cccccc !important;
            font-family: 'Consolas', 'Courier New', monospace !important;
        }
        
        .terminal-tab {
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            padding: 0.4rem 0.8rem !important;
            border: none !important;
            background: transparent !important;
            color: #969696 !important;
        }
        
        .terminal-tab.active {
            background: #1e1e1e !important;
            color: #ffffff !important;
            border-bottom: 2px solid #007acc !important;
        }
        
        .terminal-tab:hover {
            color: #ffffff !important;
            background: #2a2d2e !important;
        }
        
        .terminal-input, .terminal-output {
            width: 100%;
            background: #1e1e1e !important;
            border: none !important; /* Remove border */
            color: #d4d4d4 !important;
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important; /* Reduced padding */
            resize: vertical;
            margin: 0 !important;
        }
        
        .terminal-input:focus, .terminal-output:focus {
            outline: none !important;
            border-color: #007acc !important;
            box-shadow: none !important;
        }
        
        .terminal-label {
            color: #608b4e !important;
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            margin: 0 !important;
            padding: 0.1rem 0.5rem !important; /* Reduced padding */
            background: #252526 !important;
            display: block;
            line-height: 1.2;
        }
        
        .terminal-toolbar {
            background: #2d2d30 !important;
            padding: 0.1rem 0.5rem !important; /* Slightly more horizontal padding */
            border-bottom: 1px solid #3c3c3c !important;
            display: flex;
            align-items: center;
            gap: 0.25rem; /* Slightly more gap */
            min-height: 24px;
        }
        
        .terminal-toolbar .btn-sm {
            padding: 0.1rem 0.35rem !important;
            font-size: 0.7rem !important;
            line-height: 1.2 !important;
        }
        
        .terminal-body {
            background: #1e1e1e !important;
            color: #d4d4d4 !important;
            padding: 0 !important; /* Remove all padding */
            overflow: hidden !important; /* Prevent overflow */
            flex: 1 1 auto !important; /* Take remaining space */
            min-height: 0 !important; /* Allow shrinking */
            display: flex !important;
            flex-direction: column !important;
        }
        
        /* Fix tab panes to show properly */
        .terminal-body .tab-content {
            flex: 1 1 auto !important;
            padding: 0 !important; /* Remove padding */
            overflow: hidden !important; /* Prevent overflow */
            min-height: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .terminal-body .tab-pane {
            display: none;
            flex: 1 1 auto;
            flex-direction: column;
            padding: 0 !important; /* Remove padding */
            overflow: hidden !important;
            min-height: 0 !important;
            margin: 0 !important;
            overflow: auto; /* Allow scrolling within pane */
        }
        
        .terminal-body .tab-pane.show.active {
            display: flex !important;
        }
        
        /* JSON Syntax Highlighting (VS Code Dark+ theme) */
        .json-output {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Courier New', monospace !important;
            font-size: 0.75rem !important;
            background: #1e1e1e !important;
            color: #d4d4d4 !important;
            padding: 0.5rem !important;
            margin: 0 !important;
            border: 1px solid #3c3c3c !important;
            border-radius: 0 !important;
        }
        
        .json-key { 
            color: #9cdcfe !important; 
            font-weight: normal !important;
        }
        
        .json-string { 
            color: #ce9178 !important; 
        }
        
        .json-number { 
            color: #b5cea8 !important; 
        }
        
        .json-boolean { 
            color: #569cd6 !important; 
            font-weight: bold !important;
        }
        
        .json-null { 
            color: #569cd6 !important; 
            font-weight: bold !important;
        }
        
        .json-punctuation { 
            color: #d4d4d4 !important; 
        }
    </style>
</head>
<body class="layout-fixed sidebar-expand-lg sidebar-mini bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
        <!--begin::Header-->
        <nav class="app-header navbar navbar-expand bg-body">
            <!--begin::Container-->
            <div class="container-fluid">
                <!--begin::Start Navbar Links-->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link" data-bs-toggle="dropdown" href="#" role="button">
                            <i class="bi bi-box me-1"></i> Functoids
                        </a>
                        <div class="dropdown-menu dropdown-menu-lg">
                            <span class="dropdown-item dropdown-header">String Functions</span>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item functoid-btn" data-type="string" draggable="true">
                                <i class="bi bi-fonts me-2"></i> String
                            </a>
                            <a href="#" class="dropdown-item functoid-btn" data-type="concat" draggable="true">
                                <i class="bi bi-plus-circle me-2"></i> Concatenate
                            </a>
                            <a href="#" class="dropdown-item functoid-btn" data-type="substring" draggable="true">
                                <i class="bi bi-scissors me-2"></i> Substring
                            </a>
                            <div class="dropdown-divider"></div>
                            <span class="dropdown-item dropdown-header">Math Functions</span>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item functoid-btn" data-type="math" draggable="true">
                                <i class="bi bi-calculator me-2"></i> Math
                            </a>
                            <a href="#" class="dropdown-item functoid-btn" data-type="add" draggable="true">
                                <i class="bi bi-plus-lg me-2"></i> Add
                            </a>
                            <a href="#" class="dropdown-item functoid-btn" data-type="multiply" draggable="true">
                                <i class="bi bi-x-lg me-2"></i> Multiply
                            </a>
                            <div class="dropdown-divider"></div>
                            <span class="dropdown-item dropdown-header">Logical Functions</span>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item functoid-btn" data-type="logical" draggable="true">
                                <i class="bi bi-check-square me-2"></i> Logical
                            </a>
                            <a href="#" class="dropdown-item functoid-btn" data-type="conditional" draggable="true">
                                <i class="bi bi-question-circle me-2"></i> Conditional
                            </a>
                            <div class="dropdown-divider"></div>
                            <span class="dropdown-item dropdown-header">Date Functions</span>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item functoid-btn" data-type="date" draggable="true">
                                <i class="bi bi-calendar-event me-2"></i> Date
                            </a>
                            <a href="#" class="dropdown-item functoid-btn" data-type="dateformat" draggable="true">
                                <i class="bi bi-calendar3 me-2"></i> Format Date
                            </a>
                        </div>
                    </li>
                </ul>
                <!--end::Start Navbar Links-->
                
                <!--begin::End Navbar Links-->
                <ul class="navbar-nav ms-auto">
                    <!--begin::Fullscreen Toggle-->
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none;"></i>
                        </a>
                    </li>
                    <!--end::Fullscreen Toggle-->
                </ul>
                <!--end::End Navbar Links-->
            </div>
            <!--end::Container-->
        </nav>
        <!--end::Header-->
        
        <!--begin::Sidebar-->
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
            <!--begin::Sidebar Brand-->
            <div class="sidebar-brand">
                <a href="index.html" class="brand-link">
                    <i class="bi bi-diagram-3 brand-image opacity-75 shadow"></i>
                    <span class="brand-text fw-light">Mapping Tool</span>
                </a>
            </div>
            <!--end::Sidebar Brand-->
            
            <!--begin::Sidebar Wrapper-->
            <div class="sidebar-wrapper">
                <nav class="mt-2">
                    <!--begin::Sidebar Menu-->
                    <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
                        <li class="nav-header">CONFIGURATION</li>
                        <li class="nav-item menu-open">
                            <a href="#" class="nav-link active">
                                <i class="nav-icon bi bi-gear"></i>
                                <p>
                                    Schema Setup
                                    <i class="nav-arrow bi bi-chevron-right"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="#" class="nav-link" id="navLoadSchemas">
                                        <i class="nav-icon bi bi-upload"></i>
                                        <p>Load Schemas</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link" id="navLoadSample">
                                        <i class="nav-icon bi bi-file-code"></i>
                                        <p>Load Sample</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <li class="nav-header">MAPPING</li>
                        <li class="nav-item menu-open">
                            <a href="#" class="nav-link">
                                <i class="nav-icon bi bi-box"></i>
                                <p>
                                    Functoids
                                    <i class="nav-arrow bi bi-chevron-right"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="string" draggable="true">
                                        <i class="nav-icon bi bi-fonts"></i>
                                        <p>String</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="math" draggable="true">
                                        <i class="nav-icon bi bi-calculator"></i>
                                        <p>Math</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="logical" draggable="true">
                                        <i class="nav-icon bi bi-check-square"></i>
                                        <p>Logical</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link functoid-btn" data-type="conversion" draggable="true">
                                        <i class="nav-icon bi bi-arrow-left-right"></i>
                                        <p>Conversion</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <li class="nav-header">ACTIONS</li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="navExecute">
                                <i class="nav-icon bi bi-play-fill text-success"></i>
                                <p>Execute Mapping</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="navGenerate">
                                <i class="nav-icon bi bi-code-square"></i>
                                <p>Generate JSON</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="clearMappings">
                                <i class="nav-icon bi bi-trash text-danger"></i>
                                <p>Clear All</p>
                            </a>
                        </li>
                    </ul>
                    <!--end::Sidebar Menu-->
                </nav>
            </div>
            <!--end::Sidebar Wrapper-->
        </aside>
        <!--end::Sidebar-->
        
        <!--begin::App Main-->
        <main class="app-main" style="padding: 0;">
            
            <div class="split" id="splitContainer">
            
                <!-- Top Panel: Mapping Canvas (75%) -->
                <div class="split-panel" id="mappingPanel">
                    <div class="card mb-0">
                        <div class="card-body p-0">
                            <div class="mapping-tool">
                                <!-- Source Schema Panel -->
                                <div class="schema-panel source-panel">
                                    <div class="panel-header bg-primary text-white" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        <i class="bi bi-box-arrow-right me-1"></i>Source
                                    </div>
                                    <div class="schema-tree" id="sourceSchema">
                                        <div class="text-center text-muted p-2">
                                            <i class="bi bi-inbox" style="font-size: 1.5rem;"></i>
                                            <p class="mt-1 mb-0" style="font-size: 0.75rem;">Load schema</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mapping Canvas -->
                                <div class="mapping-canvas">
                                    <svg id="mappingSvg" class="mapping-svg"></svg>
                                    <div class="functoid-area" id="functoidArea"></div>
                                </div>

                                <!-- Destination Schema Panel -->
                                <div class="schema-panel destination-panel">
                                    <div class="panel-header bg-success text-white" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                        <i class="bi bi-box-arrow-in-left me-1"></i>Destination
                                    </div>
                                    <div class="schema-tree" id="destinationSchema">
                                        <div class="text-center text-muted p-2">
                                            <i class="bi bi-inbox" style="font-size: 1.5rem;"></i>
                                            <p class="mt-1 mb-0" style="font-size: 0.75rem;">Load schema</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Panel: Configuration & Output (25%) -->
                <div class="split-panel" id="configPanel">
                    <div class="card mb-0 terminal-panel">
                        <div class="card-header terminal-header p-0">
                            <ul class="nav nav-tabs" role="tablist" style="margin: 0; border: none; background: transparent;">
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-content" type="button" role="tab">
                                        <i class="bi bi-file-earmark-code me-1"></i>schemas.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="sample-tab" data-bs-toggle="tab" data-bs-target="#sample-content" type="button" role="tab">
                                        <i class="bi bi-database me-1"></i>sample.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="mapping-tab" data-bs-toggle="tab" data-bs-target="#mapping-content" type="button" role="tab">
                                        <i class="bi bi-diagram-2 me-1"></i>mapping.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="output-tab" data-bs-toggle="tab" data-bs-target="#output-content" type="button" role="tab">
                                        <i class="bi bi-play-circle me-1"></i>output.json
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link terminal-tab" id="csharp-tab" data-bs-toggle="tab" data-bs-target="#csharp-content" type="button" role="tab">
                                        <i class="bi bi-filetype-cs me-1"></i>mapper.cs
                                    </button>
                                </li>
                                <li class="nav-item ms-auto" style="display: flex; align-items: center; padding-right: 0.5rem;">
                                    <span class="badge bg-info me-2" id="mappingCount" style="font-size: 0.7rem; font-family: 'Consolas', monospace;">0 mappings</span>
                                    <button class="btn btn-sm btn-link text-white p-0" id="toggleFullscreen" title="Toggle Fullscreen" style="font-size: 1rem; line-height: 1;">
                                        <i class="bi bi-arrows-fullscreen"></i>
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body terminal-body p-0">
                            <div class="tab-content">
                                <!-- schemas.json Tab -->
                                <div class="tab-pane fade show active" id="config-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-secondary me-1" id="loadSchemas" title="Load Schemas">
                                            <i class="bi bi-upload me-1"></i>Load
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="formatSchemaJSON()" title="Format JSON">
                                            <i class="bi bi-code-square me-1"></i>Format
                                        </button>
                                    </div>
                                    <!-- Split layout: Source and Destination side by side -->
                                    <div style="flex: 1; display: flex; flex-direction: row !important; overflow: hidden; padding: 0; margin: 0; gap: 2px; background: #1e1e1e;">
                                        <!-- Left: Source Schema -->
                                        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0; min-width: 0;">
                                            <label class="terminal-label" style="margin: 0; flex-shrink: 0;">Source Schema:</label>
                                            <json-editor id="sourceSchemaInput" rows="4" style="flex: 1; min-height: 60px; width: 100%;"></json-editor>
                                        </div>
                                        <!-- Right: Destination Schema -->
                                        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0; min-width: 0;">
                                            <label class="terminal-label" style="margin: 0; flex-shrink: 0;">Destination Schema:</label>
                                            <json-editor id="destSchemaInput" rows="4" style="flex: 1; min-height: 60px; width: 100%;"></json-editor>
                                        </div>
                                    </div>
                                </div>

                                <!-- sample.json Tab -->
                                <div class="tab-pane fade" id="sample-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-secondary me-1" id="loadSampleData" title="Load Sample">
                                            <i class="bi bi-file-earmark-code me-1"></i>Load
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="formatSampleJSON()" title="Format JSON">
                                            <i class="bi bi-code-square me-1"></i>Format
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Sample Input Data:</label>
                                        <json-editor id="sourceDataInput" rows="10" style="flex: 1; min-height: 100px;"></json-editor>
                                    </div>
                                </div>

                                <!-- mapping.json Tab -->
                                <div class="tab-pane fade" id="mapping-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-primary me-1" id="generateOutput" title="Generate Mapping">
                                            <i class="bi bi-download me-1"></i>Generate
                                        </button>
                                        <button class="btn btn-sm btn-warning me-1" onclick="clearAll()" title="Clear All Mappings">
                                            <i class="bi bi-trash me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-sm btn-info me-1" id="loadMapping" title="Load Mapping">
                                            <i class="bi bi-upload me-1"></i>Load
                                        </button>
                                        <button class="btn btn-sm btn-secondary" id="copyOutput" title="Copy to Clipboard">
                                            <i class="bi bi-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Generated Mapping JSON:</label>
                                        <json-viewer id="mappingOutput" style="flex: 1; min-height: 100px;"></json-viewer>
                                    </div>
                                </div>

                                <!-- output.json Tab -->
                                <div class="tab-pane fade" id="output-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-success me-1" id="executeMapping" title="Execute Mapping">
                                            <i class="bi bi-play-fill me-1"></i>Execute
                                        </button>
                                        <button class="btn btn-sm btn-secondary" id="copyResult" title="Copy to Clipboard">
                                            <i class="bi bi-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Execution Result:</label>
                                        <json-viewer id="executionResult" style="flex: 1; min-height: 100px;"></json-viewer>
                                    </div>
                                </div>

                                <!-- mapper.cs Tab -->
                                <div class="tab-pane fade" id="csharp-content" role="tabpanel" style="padding: 0; margin: 0;">
                                    <div class="terminal-toolbar" style="flex-shrink: 0;">
                                        <button class="btn btn-sm btn-primary me-1" id="generateCSharp" title="Generate C# Code">
                                            <i class="bi bi-code-slash me-1"></i>Generate
                                        </button>
                                        <button class="btn btn-sm btn-secondary" id="copyCSharp" title="Copy to Clipboard">
                                            <i class="bi bi-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0;">
                                        <label class="terminal-label" style="margin: 0;">Generated C# Mapper Class:</label>
                                        <csharp-viewer id="csharpOutput" style="flex: 1; min-height: 100px;"></csharp-viewer>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <!-- End Split Container -->
        </main>
        <!--end::App Main-->
    </div>
    <!--end::App Wrapper-->
    
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js" crossorigin="anonymous"></script>
    <!--end::Third Party Plugin(OverlayScrollbars)-->
    
    <!--begin::Required Plugin(popperjs for Bootstrap 5)-->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <!--end::Required Plugin(popperjs for Bootstrap 5)-->
    
    <!--begin::Required Plugin(Bootstrap 5)-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!--end::Required Plugin(Bootstrap 5)-->
    
    <!--begin::Required Plugin(AdminLTE) - Using unpkg as fallback-->
    <script src="https://unpkg.com/admin-lte@4.0.0-beta3/dist/js/adminlte.min.js" crossorigin="anonymous"></script>
    <!--end::Required Plugin(AdminLTE)-->
    
    <!--begin::Toastify JS-->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js" crossorigin="anonymous"></script>
    <!--end::Toastify JS-->
    
    <!--begin::Split.js for Resizable Panes-->
    <script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js"></script>
    <!--end::Split.js-->
    
    <!--begin::Toast Helper Function-->
    <script>
        // Global toast notification helper
        window.showToast = function(message, type = 'info') {
            const styles = {
                success: {
                    background: '#10b981',
                    color: '#ffffff'
                },
                error: {
                    background: '#ef4444',
                    color: '#ffffff'
                },
                warning: {
                    background: '#f59e0b',
                    color: '#000000'
                },
                info: {
                    background: '#3b82f6',
                    color: '#ffffff'
                }
            };
            
            const style = styles[type] || styles.info;
            
            Toastify({
                text: message,
                duration: 3000,
                gravity: "bottom",
                position: "right",
                stopOnFocus: true,
                style: {
                    background: style.background,
                    color: style.color,
                    borderRadius: "4px",
                    fontFamily: "'Consolas', 'Courier New', monospace",
                    fontSize: "0.85rem",
                    fontWeight: "500",
                    minWidth: "300px",
                    maxWidth: "300px"
                }
            }).showToast();
        };
    </script>
    <!--end::Toast Helper Function-->
    
    <!--begin::OverlayScrollbars Configure-->
    <script>
        const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
        const Default = {
            scrollbarTheme: "os-theme-light",
            scrollbarAutoHide: "leave",
            scrollbarClickScroll: true
        };
        
        document.addEventListener("DOMContentLoaded", function() {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && typeof OverlayScrollbarsGlobal !== 'undefined') {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: {
                        theme: Default.scrollbarTheme,
                        autoHide: Default.scrollbarAutoHide,
                        clickScroll: Default.scrollbarClickScroll
                    }
                });
            }
        });
    </script>
    <!--end::OverlayScrollbars Configure-->
    
    <!--begin::AdminLTE App and Components-->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Initialize AdminLTE Treeview
            const treeviewEl = document.querySelector('[data-lte-toggle="treeview"]');
            if (treeviewEl && typeof lte !== 'undefined' && lte.Treeview) {
                new lte.Treeview(treeviewEl);
            }
            
            // Function to redraw connectors
            function redrawConnectors() {
                if (window.mappingToolInstance && window.mappingToolInstance.updateAllMappingLines) {
                    window.mappingToolInstance.updateAllMappingLines();
                }
            }
            
            // Listen to AdminLTE 4's built-in sidebar toggle events
            document.addEventListener('lte.pushmenu.collapsed', () => {
                setTimeout(redrawConnectors, 300);
            });
            
            document.addEventListener('lte.pushmenu.expanded', () => {
                setTimeout(redrawConnectors, 300);
            });
            
            // Also listen to older AdminLTE 3 events for compatibility
            document.addEventListener('collapsed.lte.pushmenu', () => {
                setTimeout(redrawConnectors, 300);
            });
            
            document.addEventListener('shown.lte.pushmenu', () => {
                setTimeout(redrawConnectors, 300);
            });
            
            // Listen to sidebar element transition end for more accurate timing
            const sidebar = document.querySelector('.app-sidebar');
            if (sidebar) {
                sidebar.addEventListener('transitionend', (e) => {
                    // Only redraw on width/margin transitions (not all transitions)
                    if (e.propertyName === 'margin-left' || e.propertyName === 'width') {
                        redrawConnectors();
                    }
                });
            }
            
            // Direct listener on the hamburger button as fallback
            const sidebarToggle = document.querySelector('[data-lte-toggle="sidebar"]');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    // Wait for animation to complete
                    setTimeout(redrawConnectors, 350);
                });
            }
            
            // Listen to window resize events to redraw connectors
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(redrawConnectors, 150);
            });
        });
    </script>
    <!--end::AdminLTE App and Components-->
    
    <!-- JSON Viewer Web Component -->
    <script src="components/json-viewer.js"></script>
    
    <!-- JSON Editor Web Component -->
    <script src="components/json-editor.js"></script>
    
    <!-- C# Viewer Web Component -->
    <script src="components/csharp-viewer.js"></script>
    
    <!-- Mapping Tool Core Logic -->
    <script src="mapping-tool.js"></script>
    
    <!-- Global Helper Functions -->
    <script>
        // Format JSON functions for toolbar buttons
        function formatSchemaJSON() {
            const sourceInput = document.getElementById('sourceSchemaInput');
            const destInput = document.getElementById('destSchemaInput');
            
            if (sourceInput && sourceInput.getValue) {
                try {
                    const json = JSON.parse(sourceInput.getValue());
                    sourceInput.setValue(JSON.stringify(json, null, 2));
                } catch (e) {
                    showToast('Invalid JSON in Source Schema', 'error');
                }
            }
            
            if (destInput && destInput.getValue) {
                try {
                    const json = JSON.parse(destInput.getValue());
                    destInput.setValue(JSON.stringify(json, null, 2));
                } catch (e) {
                    showToast('Invalid JSON in Destination Schema', 'error');
                }
            }
        }
        
        function formatSampleJSON() {
            const sampleInput = document.getElementById('sourceDataInput');
            if (sampleInput && sampleInput.getValue) {
                try {
                    const json = JSON.parse(sampleInput.getValue());
                    sampleInput.setValue(JSON.stringify(json, null, 2));
                } catch (e) {
                    showToast('Invalid JSON in Sample Data', 'error');
                }
            }
        }
        
        function clearAll() {
            if (window.mappingToolInstance && window.mappingToolInstance.clearAllMappings) {
                window.mappingToolInstance.clearAllMappings();
            }
        }
    </script>
    
    <!-- Sidebar Navigation Handlers -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Watch for AdminLTE sidebar toggle events
            
            // Link sidebar actions to main buttons
            document.getElementById('navLoadSchemas')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loadSchemas').click();
            });
            
            document.getElementById('navLoadSample')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loadSampleData').click();
            });
            
            document.getElementById('navExecute')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('executeMapping')?.click();
            });
            
            document.getElementById('navGenerate')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('generateOutput').click();
            });
            
            // Functoid sidebar links - handle both class and data-functoid for backwards compatibility
            // Use event delegation to avoid multiple handlers on the same element
            const handleFunctoidClick = (e) => {
                const target = e.target.closest('.functoid-btn, [data-functoid]');
                if (!target) return;
                
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation(); // Prevent other handlers from firing
                
                const type = target.getAttribute('data-type') || target.getAttribute('data-functoid');
                // Access the global MappingTool instance
                if (window.mappingToolInstance && type) {
                    window.mappingToolInstance.addFunctoid(type);
                }
            };
            
            // Add event listener to document for event delegation
            document.addEventListener('click', handleFunctoidClick, true); // Use capture phase
            
            // Update mapping count
            function updateMappingCount() {
                const count = window.mappingToolInstance?.mappings?.length || 0;
                const badge = document.getElementById('mappingCount');
                if (badge) {
                    badge.textContent = `${count} mapping${count !== 1 ? 's' : ''}`;
                }
            }
            
            // Call update every second (or trigger from mapping tool)
            setInterval(updateMappingCount, 1000);
            
            // Fullscreen toggle
            document.getElementById('toggleFullscreen')?.addEventListener('click', function() {
                const splitContainer = document.getElementById('splitContainer');
                if (!document.fullscreenElement) {
                    splitContainer.requestFullscreen().catch(err => {
                        console.error('Error attempting to enable fullscreen:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            });
            
            // C# Code Generation
            document.getElementById('generateCSharp')?.addEventListener('click', function() {
                if (window.mappingToolInstance) {
                    const csharpCode = window.mappingToolInstance.generateCSharpCode();
                    const outputElement = document.getElementById('csharpOutput');
                    if (outputElement && csharpCode) {
                        // Use the setCode method for csharp-viewer
                        outputElement.setCode(csharpCode);
                        showToast('C# code generated successfully!', 'success');
                    }
                }
            });
            
            document.getElementById('copyCSharp')?.addEventListener('click', function() {
                const outputElement = document.getElementById('csharpOutput');
                if (outputElement) {
                    const code = outputElement.getText();
                    if (!code) {
                        showToast('Please generate C# code first!', 'warning');
                        return;
                    }
                    navigator.clipboard.writeText(code).then(() => {
                        showToast('C# code copied to clipboard!', 'success');
                    }).catch(err => {
                        showToast('Failed to copy: ' + err, 'error');
                    });
                }
            });
            
            // Initialize Split.js for resizable panes - mapping on top, config on bottom
            console.log('Initializing Split.js...');
            console.log('Split available:', typeof Split);
            console.log('Mapping panel:', document.getElementById('mappingPanel'));
            console.log('Config panel:', document.getElementById('configPanel'));
            
            if (typeof Split !== 'undefined') {
                const splitInstance = Split(['#mappingPanel', '#configPanel'], {
                    direction: 'vertical',
                    sizes: [75, 25],  // Initial sizes: 75% canvas, 25% config/output
                    minSize: [300, 150],  // Minimum sizes for each panel
                    gutterSize: 8,
                    cursor: 'row-resize',
                    onDragEnd: function() {
                        console.log('Split drag ended');
                        // Redraw mapping lines after resize
                        if (window.mappingToolInstance && window.mappingToolInstance.updateAllMappingLines) {
                            window.mappingToolInstance.updateAllMappingLines();
                        }
                    }
                });
                console.log('Split.js initialized:', splitInstance);
            } else {
                console.error('Split.js not loaded!');
            }
        });
    </script>
</body>
</html>
